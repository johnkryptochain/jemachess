/**
 * ULTIMATE RESPONSIVE SOLUTION 2025
 * 
 * This is the most robust responsive solution using:
 * - CSS Container Queries (for component-based responsive)
 * - CSS Layers (for proper cascade management)
 * - Dynamic Viewport Units (dvh, svh, lvh)
 * - CSS clamp() for fluid sizing
 * - aspect-ratio for perfect squares
 * - JavaScript-based viewport detection as fallback
 * 
 * Supports ALL devices:
 * - iPhone 4/5/SE to iPhone 15 Pro Max
 * - Samsung Galaxy S8 to S24 Ultra
 * - Honor Magic V2/V3/V5 (foldable)
 * - Samsung Galaxy Z Fold 3/4/5 (foldable)
 * - Oppo Find N2/N3 (foldable)
 * - All tablets and desktops
 */

/* ============================================
   CSS LAYERS - Proper cascade management
   ============================================ */
@layer reset, base, layout, components, responsive, utilities;

/* ============================================
   BASE LAYER - Core responsive variables
   ============================================ */
@layer base {
  :root {
    /* Dynamic viewport units with fallbacks */
    --vh: 1vh;
    --dvh: 1dvh;
    --svh: 1svh;
    
    /* Safe area insets */
    --safe-top: env(safe-area-inset-top, 0px);
    --safe-bottom: env(safe-area-inset-bottom, 0px);
    --safe-left: env(safe-area-inset-left, 0px);
    --safe-right: env(safe-area-inset-right, 0px);
    
    /* Responsive spacing using clamp */
    --space-xs: clamp(2px, 0.5vmin, 4px);
    --space-sm: clamp(4px, 1vmin, 8px);
    --space-md: clamp(8px, 2vmin, 16px);
    --space-lg: clamp(12px, 3vmin, 24px);
    --space-xl: clamp(16px, 4vmin, 32px);
    
    /* Board size - calculated by JavaScript, with CSS fallback */
    --board-size: min(
      calc(100vw - var(--space-md) * 2),
      calc(100dvh - 200px),
      560px
    );
    
    /* Font sizes using clamp */
    --text-xs: clamp(9px, 2vmin, 11px);
    --text-sm: clamp(10px, 2.5vmin, 13px);
    --text-md: clamp(12px, 3vmin, 16px);
    --text-lg: clamp(14px, 3.5vmin, 20px);
    --text-xl: clamp(16px, 4vmin, 24px);
    
    /* Touch target minimum (WCAG 2.2) */
    --touch-target: max(44px, 11vmin);
  }
}

/* ============================================
   LAYOUT LAYER - Container setup
   ============================================ */
@layer layout {
  /* Enable container queries on game container */
  .game-container {
    container-type: inline-size;
    container-name: game;
  }
  
  .board-container {
    container-type: inline-size;
    container-name: board;
  }
  
  .side-panel {
    container-type: inline-size;
    container-name: panel;
  }
}

/* ============================================
   COMPONENTS LAYER - Base component styles
   ============================================ */
@layer components {
  /* Chess board with perfect aspect ratio */
  .chess-board {
    aspect-ratio: 1 / 1;
    width: var(--board-size, min(80vmin, 560px));
    height: auto;
    max-width: 100%;
    contain: layout style paint;
  }
  
  /* Player cards */
  .player-card {
    min-height: var(--touch-target);
    padding: var(--space-sm) var(--space-md);
  }
  
  /* Icon buttons with minimum touch target */
  .icon-btn {
    min-width: var(--touch-target);
    min-height: var(--touch-target);
    width: clamp(36px, 10vmin, 48px);
    height: clamp(36px, 10vmin, 48px);
  }
}

/* ============================================
   RESPONSIVE LAYER - Container Queries
   ============================================ */
@layer responsive {
  
  /* ========== EXTRA SMALL CONTAINERS (< 320px) ========== */
  @container game (max-width: 319px) {
    .game-container {
      gap: var(--space-xs) !important;
      padding: var(--space-xs) !important;
    }
    
    .chess-board {
      --board-size: calc(100cqw - 8px);
      max-width: 300px;
      max-height: 300px;
    }
    
    .player-card {
      padding: 3px 6px !important;
    }
    
    .player-avatar {
      width: 24px !important;
      height: 24px !important;
    }
    
    .player-name {
      font-size: var(--text-xs) !important;
    }
    
    .player-timer {
      font-size: var(--text-sm) !important;
    }
    
    .icon-btn {
      width: 30px !important;
      height: 30px !important;
      min-width: 30px !important;
      min-height: 30px !important;
    }
  }
  
  /* ========== SMALL CONTAINERS (320px - 374px) ========== */
  @container game (min-width: 320px) and (max-width: 374px) {
    .game-container {
      gap: var(--space-xs) !important;
      padding: var(--space-xs) !important;
    }
    
    .chess-board {
      --board-size: calc(100cqw - 12px);
      max-width: 340px;
      max-height: 340px;
    }
    
    .player-card {
      padding: 4px 8px !important;
    }
    
    .player-avatar {
      width: 28px !important;
      height: 28px !important;
    }
    
    .player-timer {
      font-size: var(--text-md) !important;
    }
    
    .icon-btn {
      width: 34px !important;
      height: 34px !important;
    }
  }
  
  /* ========== MEDIUM CONTAINERS (375px - 430px) ========== */
  @container game (min-width: 375px) and (max-width: 430px) {
    .game-container {
      gap: var(--space-sm) !important;
      padding: var(--space-sm) !important;
    }
    
    .chess-board {
      --board-size: calc(100cqw - 16px);
      max-width: 380px;
      max-height: 380px;
    }
    
    .player-card {
      padding: 6px 10px !important;
    }
    
    .player-avatar {
      width: 32px !important;
      height: 32px !important;
    }
    
    .player-timer {
      font-size: var(--text-lg) !important;
    }
    
    .icon-btn {
      width: 38px !important;
      height: 38px !important;
    }
  }
  
  /* ========== LARGE PHONE CONTAINERS (431px - 600px) ========== */
  @container game (min-width: 431px) and (max-width: 600px) {
    .game-container {
      gap: var(--space-md) !important;
      padding: var(--space-md) !important;
    }
    
    .chess-board {
      --board-size: min(calc(100cqw - 24px), 450px);
    }
    
    .player-card {
      padding: 8px 12px !important;
    }
    
    .player-avatar {
      width: 36px !important;
      height: 36px !important;
    }
    
    .icon-btn {
      width: 42px !important;
      height: 42px !important;
    }
  }
  
  /* ========== TABLET/FOLDABLE UNFOLDED (601px - 900px) ========== */
  @container game (min-width: 601px) and (max-width: 900px) {
    .game-container {
      display: flex !important;
      flex-direction: column !important;
      align-items: center !important;
      gap: var(--space-md) !important;
      padding: var(--space-md) !important;
    }
    
    .chess-board {
      --board-size: min(calc(100cqw - 32px), 520px);
    }
    
    .side-panel {
      flex-direction: row !important;
      justify-content: center !important;
      width: 100% !important;
      gap: var(--space-lg) !important;
    }
    
    .player-card {
      padding: 10px 16px !important;
      max-width: 220px !important;
    }
    
    .player-avatar {
      width: 40px !important;
      height: 40px !important;
    }
    
    .icon-btn {
      width: 44px !important;
      height: 44px !important;
    }
  }
  
  /* ========== LARGE TABLET/FOLDABLE (901px - 1100px) ========== */
  @container game (min-width: 901px) and (max-width: 1100px) {
    .game-container {
      display: flex !important;
      flex-direction: column !important;
      align-items: center !important;
      gap: var(--space-lg) !important;
      padding: var(--space-lg) !important;
    }
    
    .chess-board {
      --board-size: min(calc(100cqw * 0.65), 580px);
    }
    
    .side-panel {
      flex-direction: row !important;
      justify-content: center !important;
      width: 100% !important;
      gap: var(--space-xl) !important;
    }
    
    .player-card {
      padding: 12px 20px !important;
      max-width: 260px !important;
    }
    
    .player-avatar {
      width: 44px !important;
      height: 44px !important;
    }
    
    .icon-btn {
      width: 48px !important;
      height: 48px !important;
    }
  }
  
  /* ========== DESKTOP (> 1100px) ========== */
  @container game (min-width: 1101px) {
    .game-container {
      display: grid !important;
      grid-template-columns: minmax(200px, 280px) auto minmax(200px, 280px) !important;
      gap: var(--space-xl) !important;
      padding: var(--space-xl) !important;
      align-items: start !important;
    }
    
    .chess-board {
      --board-size: min(calc(100cqw * 0.5), 600px);
    }
    
    .side-panel {
      flex-direction: column !important;
      width: auto !important;
    }
    
    .side-panel.left {
      align-items: flex-end !important;
    }
    
    .side-panel.right {
      align-items: flex-start !important;
    }
    
    .player-card {
      padding: 14px 24px !important;
      min-width: 200px !important;
    }
    
    .player-avatar {
      width: 48px !important;
      height: 48px !important;
    }
    
    .icon-btn {
      width: 48px !important;
      height: 48px !important;
    }
  }
}

/* ============================================
   UTILITIES LAYER - Highest priority overrides
   ============================================ */
@layer utilities {
  
  /* Force vertical layout on mobile */
  .force-vertical {
    display: flex !important;
    flex-direction: column !important;
  }
  
  /* Force horizontal layout */
  .force-horizontal {
    display: flex !important;
    flex-direction: row !important;
  }
  
  /* Hide on mobile */
  .hide-mobile {
    display: none !important;
  }
  
  /* Show on mobile */
  .show-mobile {
    display: flex !important;
  }
  
  /* Safe area padding */
  .safe-area-padding {
    padding-top: var(--safe-top);
    padding-bottom: var(--safe-bottom);
    padding-left: var(--safe-left);
    padding-right: var(--safe-right);
  }
}

/* ============================================
   FALLBACK MEDIA QUERIES
   For browsers that don't support container queries
   ============================================ */
@supports not (container-type: inline-size) {
  
  /* Small phones */
  @media (max-width: 374px) {
    .game-container {
      gap: 4px !important;
      padding: 4px !important;
    }
    
    .chess-board {
      width: calc(100vw - 12px) !important;
      height: calc(100vw - 12px) !important;
      max-width: 340px !important;
      max-height: 340px !important;
    }
  }
  
  /* Medium phones */
  @media (min-width: 375px) and (max-width: 430px) {
    .game-container {
      gap: 6px !important;
      padding: 6px !important;
    }
    
    .chess-board {
      width: calc(100vw - 16px) !important;
      height: calc(100vw - 16px) !important;
      max-width: 380px !important;
      max-height: 380px !important;
    }
  }
  
  /* Large phones */
  @media (min-width: 431px) and (max-width: 600px) {
    .chess-board {
      width: min(calc(100vw - 24px), 450px) !important;
      height: min(calc(100vw - 24px), 450px) !important;
    }
  }
  
  /* Tablets */
  @media (min-width: 601px) and (max-width: 1100px) {
    .game-container {
      display: flex !important;
      flex-direction: column !important;
      align-items: center !important;
    }
    
    .chess-board {
      width: min(65vmin, 560px) !important;
      height: min(65vmin, 560px) !important;
    }
    
    .side-panel {
      flex-direction: row !important;
      width: 100% !important;
      justify-content: center !important;
    }
  }
  
  /* Desktop */
  @media (min-width: 1101px) {
    .game-container {
      display: grid !important;
      grid-template-columns: minmax(200px, 280px) auto minmax(200px, 280px) !important;
    }
    
    .chess-board {
      width: min(80vmin, 600px) !important;
      height: min(80vmin, 600px) !important;
    }
    
    .side-panel {
      flex-direction: column !important;
    }
  }
}

/* ============================================
   DYNAMIC VIEWPORT HEIGHT FIX
   For mobile browsers with dynamic toolbars
   ============================================ */
@supports (height: 100dvh) {
  .app-container {
    min-height: 100dvh;
  }
  
  .game-container {
    min-height: calc(100dvh - var(--space-md) * 2);
    max-height: 100dvh;
  }
}

@supports not (height: 100dvh) {
  .app-container {
    min-height: 100vh;
    min-height: -webkit-fill-available;
  }
  
  .game-container {
    min-height: calc(100vh - 16px);
    min-height: calc(-webkit-fill-available - 16px);
  }
}

/* ============================================
   ASPECT RATIO BASED LAYOUTS
   For foldable phones with square-ish screens
   ONLY applies to screens smaller than 1200px (not laptops)
   ============================================ */

/* Square-ish screens (foldables unfolded) - NOT for laptops */
@media (min-aspect-ratio: 3/4) and (max-aspect-ratio: 4/3) and (min-width: 600px) and (max-width: 1200px) {
  .game-container {
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
    justify-content: center !important;
  }
  
  .chess-board {
    width: min(65vmin, 580px) !important;
    height: min(65vmin, 580px) !important;
  }
  
  .side-panel {
    flex-direction: row !important;
    justify-content: center !important;
    width: 100% !important;
  }
  
  .board-container {
    order: 2 !important;
  }
  
  .side-panel.left {
    order: 1 !important;
  }
  
  .side-panel.right {
    order: 3 !important;
  }
}

/* Tall screens (phones in portrait) - NOT for laptops */
@media (max-aspect-ratio: 3/4) and (max-width: 1200px) {
  .game-container {
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
  }
  
  .side-panel {
    flex-direction: row !important;
    width: 100% !important;
    justify-content: center !important;
  }
}

/* Wide screens (landscape) - for tablets only, not laptops */
@media (min-aspect-ratio: 4/3) and (min-width: 600px) and (max-width: 1200px) {
  .game-container {
    display: grid !important;
    grid-template-columns: 1fr auto 1fr !important;
    align-items: center !important;
  }
  
  .side-panel {
    flex-direction: column !important;
  }
}

/* ============================================
   ORIENTATION SPECIFIC STYLES
   ============================================ */

/* Portrait orientation - ONLY for mobile/tablet screens (not laptops) */
@media (orientation: portrait) and (max-width: 1200px) {
  .game-container {
    flex-direction: column !important;
  }
  
  .side-panel {
    flex-direction: row !important;
    width: 100% !important;
  }
}

/* Landscape orientation on phones */
@media (orientation: landscape) and (max-height: 500px) {
  .game-container {
    flex-direction: row !important;
    flex-wrap: wrap !important;
    justify-content: center !important;
    align-items: flex-start !important;
    padding: var(--space-xs) !important;
  }
  
  .chess-board {
    width: min(90vh, 90dvh, 400px) !important;
    height: min(90vh, 90dvh, 400px) !important;
  }
  
  .side-panel {
    flex-direction: column !important;
    width: auto !important;
    max-width: 120px !important;
  }
  
  .player-card {
    flex-direction: column !important;
    text-align: center !important;
    padding: var(--space-xs) !important;
  }
  
  .game-actions {
    flex-direction: column !important;
    padding: var(--space-xs) !important;
  }
}

/* ============================================
   JAVASCRIPT VIEWPORT CLASSES
   Applied by ViewportDetector for maximum reliability
   ============================================ */

/* These classes override everything when applied */
html.viewport-phone-small .chess-board,
body.viewport-phone-small .chess-board {
  width: var(--optimal-board-size, 300px) !important;
  height: var(--optimal-board-size, 300px) !important;
}

html.viewport-phone-medium .chess-board,
body.viewport-phone-medium .chess-board {
  width: var(--optimal-board-size, 340px) !important;
  height: var(--optimal-board-size, 340px) !important;
}

html.viewport-phone-large .chess-board,
body.viewport-phone-large .chess-board {
  width: var(--optimal-board-size, 380px) !important;
  height: var(--optimal-board-size, 380px) !important;
}

html.viewport-foldable-folded .chess-board,
body.viewport-foldable-folded .chess-board {
  width: var(--optimal-board-size, 320px) !important;
  height: var(--optimal-board-size, 320px) !important;
}

html.viewport-foldable-unfolded .chess-board,
body.viewport-foldable-unfolded .chess-board {
  width: var(--optimal-board-size, 520px) !important;
  height: var(--optimal-board-size, 520px) !important;
}

html.viewport-tablet .chess-board,
body.viewport-tablet .chess-board {
  width: var(--optimal-board-size, 500px) !important;
  height: var(--optimal-board-size, 500px) !important;
}

html.viewport-desktop .chess-board,
body.viewport-desktop .chess-board {
  width: var(--optimal-board-size, 560px) !important;
  height: var(--optimal-board-size, 560px) !important;
}

/* ============================================
   GAME ACTIONS VISIBILITY FIX
   Ensure buttons are always visible
   ============================================ */
.game-actions {
  display: flex !important;
  visibility: visible !important;
  opacity: 1 !important;
}

.game-actions-row {
  display: flex !important;
  visibility: visible !important;
}

.icon-btn {
  display: flex !important;
  visibility: visible !important;
}

/* ============================================
   LAPTOP & DESKTOP OVERRIDE (> 1200px)
   This MUST be at the end to override all other rules
   Forces 3-column grid layout on large screens
   ============================================ */
@media (min-width: 1201px) {
  .game-container {
    display: grid !important;
    grid-template-columns: minmax(200px, 280px) minmax(400px, 600px) minmax(200px, 280px) !important;
    grid-template-rows: 1fr !important;
    flex-direction: unset !important;
    gap: 24px !important;
    max-width: 1400px !important;
    margin: 0 auto !important;
    padding: 20px !important;
    align-items: start !important;
    justify-content: center !important;
    min-height: auto !important;
    overflow: visible !important;
  }
  
  .side-panel {
    display: flex !important;
    flex-direction: column !important;
    gap: 16px !important;
    width: 100% !important;
    position: relative !important;
    z-index: 1 !important;
  }
  
  .side-panel.left {
    order: 1 !important;
    align-items: flex-end !important;
    grid-column: 1 !important;
  }
  
  .board-container {
    order: 2 !important;
    grid-column: 2 !important;
    display: flex !important;
    justify-content: center !important;
    align-items: flex-start !important;
  }
  
  .side-panel.right {
    order: 3 !important;
    align-items: flex-start !important;
    grid-column: 3 !important;
  }
  
  .chess-board {
    width: min(60vh, 560px) !important;
    height: min(60vh, 560px) !important;
    max-width: 560px !important;
    max-height: 560px !important;
  }
  
  .player-card {
    min-width: 180px !important;
    max-width: 260px !important;
    width: 100% !important;
    flex-direction: row !important;
  }
  
  .player-avatar {
    width: 40px !important;
    height: 40px !important;
  }
  
  .player-name {
    font-size: 14px !important;
  }
  
  .player-timer {
    font-size: 20px !important;
  }
  
  .move-history {
    display: block !important;
    max-height: 250px !important;
    width: 100% !important;
  }
  
  .game-actions {
    display: flex !important;
    flex-direction: column !important;
    gap: 12px !important;
    width: 100% !important;
    padding: 16px !important;
    order: unset !important;
  }
  
  .game-actions-row {
    display: flex !important;
    justify-content: center !important;
    gap: 10px !important;
  }
  
  .icon-btn {
    width: 44px !important;
    height: 44px !important;
  }
  
  .icon-btn svg {
    width: 20px !important;
    height: 20px !important;
  }
  
  .glass-button.danger {
    padding: 10px 20px !important;
    font-size: 14px !important;
  }
  
  /* Board coordinates are hidden - internal coordinates on squares are used instead */
  .board-coordinates {
    display: none !important;
  }
}

/* Smaller laptops (1201px - 1400px) */
@media (min-width: 1201px) and (max-width: 1400px) {
  .game-container {
    grid-template-columns: minmax(160px, 200px) minmax(380px, 500px) minmax(160px, 200px) !important;
    gap: 12px !important;
    padding: 10px !important;
  }
  
  .chess-board {
    width: min(55vh, 480px) !important;
    height: min(55vh, 480px) !important;
    max-width: 480px !important;
    max-height: 480px !important;
  }
  
  .player-card {
    min-width: 140px !important;
    max-width: 180px !important;
    padding: 8px 10px !important;
  }
  
  .player-avatar {
    width: 32px !important;
    height: 32px !important;
  }
  
  .player-name {
    font-size: 12px !important;
  }
  
  .player-timer {
    font-size: 16px !important;
  }
  
  .move-history {
    max-height: 150px !important;
  }
  
  .game-actions {
    padding: 8px !important;
    gap: 6px !important;
    width: 100% !important;
    max-width: 180px !important;
  }
  
  .game-actions-row {
    gap: 6px !important;
    flex-wrap: wrap !important;
    justify-content: center !important;
  }
  
  .icon-btn {
    width: 36px !important;
    height: 36px !important;
  }
  
  .icon-btn svg {
    width: 16px !important;
    height: 16px !important;
  }
  
  .glass-button.danger {
    padding: 8px 14px !important;
    font-size: 12px !important;
    width: 100% !important;
    max-width: 160px !important;
  }
}

/* Very large screens (> 1600px) */
@media (min-width: 1601px) {
  .game-container {
    grid-template-columns: minmax(250px, 320px) minmax(500px, 700px) minmax(250px, 320px) !important;
    gap: 32px !important;
    max-width: 1600px !important;
    padding: 24px !important;
  }
  
  .chess-board {
    width: min(65vh, 650px) !important;
    height: min(65vh, 650px) !important;
    max-width: 650px !important;
    max-height: 650px !important;
  }
  
  .player-card {
    min-width: 220px !important;
    max-width: 300px !important;
    padding: 14px 20px !important;
  }
  
  .player-avatar {
    width: 48px !important;
    height: 48px !important;
  }
  
  .player-name {
    font-size: 16px !important;
  }
  
  .player-timer {
    font-size: 24px !important;
  }
  
  .move-history {
    max-height: 350px !important;
  }
  
  .icon-btn {
    width: 50px !important;
    height: 50px !important;
  }
  
  .icon-btn svg {
    width: 24px !important;
    height: 24px !important;
  }
}

/* ============================================
   MOBILE BASE STYLES (max-width: 768px)
   ============================================ */
@media (max-width: 768px) {
  body {
    font-size: 14px;
  }

  .app-container {
    padding: 4px !important;
    min-height: 100vh;
    min-height: 100dvh;
    max-height: 100vh;
    max-height: 100dvh;
    box-sizing: border-box;
    overflow: hidden !important;
  }

  /* Game container - vertical layout on mobile - NO SCROLL */
  .game-container {
    display: flex !important;
    flex-direction: column !important;
    grid-template-columns: none !important;
    gap: 8px !important;
    padding: 4px !important;
    max-width: 100% !important;
    width: 100% !important;
    align-items: center;
    height: calc(100vh - 8px) !important;
    height: calc(100dvh - 8px) !important;
    min-height: auto !important;
    max-height: calc(100vh - 8px) !important;
    max-height: calc(100dvh - 8px) !important;
    justify-content: flex-start !important;
    box-sizing: border-box;
    overflow: hidden !important;
  }

  /* Side panels - MUST BE VISIBLE */
  .side-panel {
    width: 100% !important;
    max-width: 100% !important;
    flex-direction: row !important;
    justify-content: center;
    align-items: center;
    gap: 8px !important;
    flex-shrink: 0 !important;
    flex-grow: 0 !important;
    overflow: visible !important;
    box-sizing: border-box;
    padding: 4px !important;
    min-height: 50px !important;
    display: flex !important;
    visibility: visible !important;
  }

  .side-panel.left {
    order: 1 !important;
  }

  .side-panel.right {
    order: 3 !important;
    flex-wrap: wrap !important;
  }

  .board-container {
    order: 2 !important;
    width: 100%;
    display: flex;
    justify-content: center;
    flex-shrink: 1 !important;
    flex-grow: 0 !important;
    min-height: 0 !important;
    overflow: visible;
  }

  /* Player cards - MUST BE VISIBLE */
  .player-card {
    min-width: 120px !important;
    max-width: 180px !important;
    width: auto !important;
    padding: 8px 12px !important;
    flex: 0 1 auto !important;
    overflow: visible !important;
    box-sizing: border-box;
    flex-direction: row !important;
    gap: 8px !important;
    align-items: center !important;
    display: flex !important;
    visibility: visible !important;
  }

  .player-avatar {
    width: 32px !important;
    height: 32px !important;
    min-width: 32px !important;
    font-size: 14px !important;
    flex-shrink: 0;
    display: flex !important;
    visibility: visible !important;
  }

  .player-info {
    min-width: 0 !important;
    overflow: hidden;
    flex: 1 1 auto;
    display: flex !important;
    flex-direction: column !important;
  }

  .player-name {
    font-size: 13px !important;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100px;
    display: block !important;
  }

  .player-rating {
    display: none !important;
  }

  .player-timer {
    font-size: 16px !important;
    flex-shrink: 0;
    white-space: nowrap;
    font-weight: 600;
    display: block !important;
  }

  /* Chess board - sized to fit with both player cards visible */
  .chess-board {
    width: min(90vw, calc(100vh - 260px), calc(100dvh - 260px)) !important;
    height: min(90vw, calc(100vh - 260px), calc(100dvh - 260px)) !important;
    max-width: 400px !important;
    max-height: 400px !important;
    flex-shrink: 0 !important;
  }
  
  /* Hide external board coordinates on mobile */
  .board-coordinates {
    display: none !important;
  }

  /* Move history - hidden on mobile */
  .move-history {
    display: none !important;
  }

  /* Game actions - COMPACT row */
  .game-actions {
    width: 100% !important;
    max-width: 100% !important;
    padding: 6px !important;
    flex-direction: row !important;
    flex-wrap: wrap !important;
    justify-content: center;
    align-items: center;
    gap: 6px !important;
    flex-shrink: 0 !important;
    flex-grow: 0 !important;
    box-sizing: border-box;
    overflow: visible !important;
    min-height: 50px !important;
    display: flex !important;
    visibility: visible !important;
  }

  .game-actions-row {
    display: flex !important;
    margin-bottom: 0 !important;
    gap: 6px !important;
    flex-wrap: wrap !important;
    justify-content: center;
  }

  .icon-btn {
    width: 40px !important;
    height: 40px !important;
    min-width: 40px !important;
    min-height: 40px !important;
    display: flex !important;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .icon-btn svg {
    width: 18px !important;
    height: 18px !important;
  }

  .glass-button.small {
    padding: 6px 10px !important;
    font-size: 11px !important;
  }

  .glass-button.danger {
    padding: 6px 12px !important;
    font-size: 11px !important;
    white-space: nowrap;
  }

  /* Toast notifications */
  .toast-container {
    bottom: 70px !important;
    right: 10px !important;
    left: 10px !important;
    max-width: none;
  }

  .toast {
    padding: 10px 14px !important;
    font-size: 13px !important;
  }

  /* Chat widget */
  .chat-overlay {
    bottom: 10px !important;
    right: 10px !important;
  }

  .chat-toggle-btn {
    width: 48px !important;
    height: 48px !important;
  }

  .chat-container {
    width: calc(100vw - 20px) !important;
    max-width: 360px !important;
    height: 50vh !important;
    max-height: 400px !important;
  }
}

/* Small phones - iPhone 4/5/SE (320px - 375px) */
@media (max-width: 375px) {
  .app-container {
    padding: 2px;
  }

  .game-container {
    gap: 4px !important;
    padding: 2px !important;
  }

  .player-card {
    padding: 4px 8px !important;
  }

  .player-avatar {
    width: 28px !important;
    height: 28px !important;
    font-size: 12px !important;
  }

  .player-name {
    font-size: 12px !important;
  }

  .player-timer {
    font-size: 14px !important;
  }

  .chess-board {
    width: min(98vw, 98vmin) !important;
    height: min(98vw, 98vmin) !important;
  }

  .icon-btn {
    width: 36px !important;
    height: 36px !important;
  }

  .icon-btn svg {
    width: 16px !important;
    height: 16px !important;
  }

  .glass-button.danger {
    padding: 6px 12px !important;
    font-size: 11px !important;
  }

  .coordinate {
    font-size: 8px !important;
  }
}

/* Very small phones - iPhone SE 2016, iPhone 4/5 (320px) */
@media (max-width: 320px) {
  .app-container {
    padding: 2px !important;
  }

  .game-container {
    gap: 2px !important;
    padding: 0 !important;
  }

  .player-card {
    padding: 3px 6px !important;
    flex-direction: row !important;
    gap: 4px !important;
  }

  .player-avatar {
    width: 24px !important;
    height: 24px !important;
    font-size: 10px !important;
  }

  .player-name {
    font-size: 10px !important;
    max-width: 50px;
  }

  .player-rating {
    font-size: 8px !important;
  }

  .player-timer {
    font-size: 11px !important;
  }

  .chess-board {
    width: calc(100vw - 8px) !important;
    height: calc(100vw - 8px) !important;
    max-width: 310px !important;
    max-height: 310px !important;
  }

  .game-actions {
    padding: 4px !important;
    gap: 4px !important;
  }

  .game-actions-row {
    gap: 4px !important;
  }

  .icon-btn {
    width: 30px !important;
    height: 30px !important;
    min-width: 30px !important;
    min-height: 30px !important;
  }

  .icon-btn svg {
    width: 14px !important;
    height: 14px !important;
  }

  .glass-button.danger {
    padding: 4px 8px !important;
    font-size: 9px !important;
  }

  .glass-button.small {
    padding: 4px 8px !important;
    font-size: 9px !important;
  }

  .coordinate {
    font-size: 6px !important;
  }

  .side-panel {
    gap: 2px !important;
    padding: 0 !important;
  }

  .toast {
    padding: 8px 10px !important;
    font-size: 11px !important;
  }

  .toast-container {
    bottom: 8px !important;
    right: 8px !important;
    left: 8px !important;
  }
}

/* ============================================
   FOLDABLE PHONES - FOLDED MODE
   Honor Magic V2/V3/V5: ~374x832
   Samsung Z Fold 3/4/5: ~374x841
   ============================================ */
@media (min-width: 370px) and (max-width: 420px) and (min-height: 800px) {
  .app-container {
    padding: 4px !important;
    min-height: 100vh;
    min-height: 100dvh;
    overflow: hidden !important;
  }

  .game-container {
    display: flex !important;
    flex-direction: column !important;
    gap: 4px !important;
    padding: 4px !important;
    align-items: center;
    justify-content: flex-start !important;
    min-height: calc(100vh - 8px);
    min-height: calc(100dvh - 8px);
    max-height: 100vh;
    max-height: 100dvh;
    overflow: hidden !important;
  }

  .chess-board {
    width: calc(100vw - 16px) !important;
    height: calc(100vw - 16px) !important;
    max-width: 320px !important;
    max-height: 320px !important;
    flex-shrink: 0 !important;
  }

  .board-container {
    order: 2 !important;
    flex-shrink: 0 !important;
  }

  .side-panel {
    width: 100%;
    flex-direction: row !important;
    justify-content: center;
    gap: 8px;
    flex-shrink: 0 !important;
    padding: 4px 0 !important;
  }

  .side-panel.left {
    order: 1 !important;
  }

  .side-panel.right {
    order: 3 !important;
    flex-wrap: wrap !important;
  }

  .player-card {
    padding: 6px 10px !important;
    max-width: 150px;
    flex: 0 1 auto;
  }

  .player-avatar {
    width: 28px !important;
    height: 28px !important;
  }

  .player-name {
    font-size: 11px !important;
  }

  .player-timer {
    font-size: 14px !important;
  }

  .game-actions {
    order: 4 !important;
    width: 100% !important;
    flex-direction: row !important;
    justify-content: center !important;
    align-items: center !important;
    gap: 6px !important;
    padding: 6px !important;
    flex-shrink: 0 !important;
    display: flex !important;
    visibility: visible !important;
    opacity: 1 !important;
    position: relative !important;
    z-index: 100 !important;
  }

  .game-actions-row {
    display: flex !important;
    gap: 6px !important;
    visibility: visible !important;
  }

  .icon-btn {
    width: 36px !important;
    height: 36px !important;
    display: flex !important;
    visibility: visible !important;
  }
  
  .glass-button.danger {
    display: inline-flex !important;
    visibility: visible !important;
    padding: 6px 12px !important;
    font-size: 11px !important;
  }
  
  .board-coordinates {
    display: none !important;
  }
  
  .move-history {
    display: none !important;
  }
}

/* ============================================
   FOLDABLE PHONES - UNFOLDED MODE
   Honor Magic V2/V3/V5: ~1040x1000
   ============================================ */
@media (min-width: 900px) and (max-width: 1100px) and (min-height: 900px) and (max-height: 1100px) {
  .app-container {
    padding: 8px !important;
    min-height: 100vh;
    min-height: 100dvh;
    overflow: hidden !important;
  }

  .game-container {
    display: flex !important;
    flex-direction: column !important;
    gap: 8px !important;
    padding: 8px !important;
    align-items: center !important;
    justify-content: flex-start !important;
    min-height: calc(100vh - 16px);
    min-height: calc(100dvh - 16px);
    max-height: 100vh;
    max-height: 100dvh;
    overflow: hidden !important;
  }

  .chess-board {
    width: min(75vw, calc(100vh - 280px), 580px) !important;
    height: min(75vw, calc(100vh - 280px), 580px) !important;
    max-width: 580px !important;
    max-height: 580px !important;
    flex-shrink: 0 !important;
  }

  .board-container {
    order: 2 !important;
    flex-shrink: 0 !important;
  }

  .side-panel {
    flex-direction: row !important;
    justify-content: center !important;
    width: 100% !important;
    gap: 24px;
    flex-shrink: 0 !important;
    padding: 8px 0 !important;
  }
  
  .side-panel.left {
    order: 1 !important;
  }
  
  .side-panel.right {
    order: 3 !important;
  }

  .player-card {
    width: auto !important;
    max-width: 240px !important;
    padding: 10px 18px !important;
  }
  
  .player-avatar {
    width: 40px !important;
    height: 40px !important;
  }
  
  .player-name {
    font-size: 14px !important;
  }
  
  .player-timer {
    font-size: 20px !important;
  }
  
  .game-actions {
    order: 4 !important;
    flex-direction: row !important;
    justify-content: center;
    gap: 12px;
    width: auto !important;
    padding: 10px !important;
    flex-shrink: 0 !important;
  }
  
  .game-actions-row {
    display: flex !important;
    gap: 12px;
  }
  
  .icon-btn {
    width: 44px !important;
    height: 44px !important;
    display: flex !important;
  }
  
  .move-history {
    display: none !important;
  }
  
  .board-coordinates {
    display: none !important;
  }
}

/* ============================================
   TABLET MODE (481px - 768px)
   ============================================ */
@media (min-width: 481px) and (max-width: 768px) {
  .game-container {
    display: flex !important;
    flex-direction: column !important;
    gap: 12px !important;
    padding: 12px !important;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    min-height: 100dvh;
  }

  .chess-board {
    width: min(80vw, 80vh, 480px) !important;
    height: min(80vw, 80vh, 480px) !important;
    max-width: 480px;
    max-height: 480px;
  }

  .side-panel {
    width: 100%;
    flex-direction: row !important;
    justify-content: center;
    gap: 16px;
  }

  .player-card {
    padding: 10px 14px !important;
    max-width: 200px;
    flex: 0 1 auto;
  }

  .player-avatar {
    width: 40px !important;
    height: 40px !important;
  }

  .player-timer {
    font-size: 20px !important;
  }

  .game-actions {
    width: 100%;
    flex-direction: row !important;
    justify-content: center;
    gap: 12px;
  }

  .game-actions-row {
    display: flex !important;
    gap: 12px;
  }

  .icon-btn {
    width: 44px !important;
    height: 44px !important;
    display: flex !important;
  }
  
  .move-history {
    display: none !important;
  }
}

/* ============================================
   TABLET/FOLDABLE LARGE (769px - 1200px)
   ============================================ */
@media (min-width: 769px) and (max-width: 1200px) {
  .game-container {
    display: flex !important;
    flex-direction: column !important;
    gap: 16px !important;
    padding: 16px !important;
    max-width: 100% !important;
    align-items: center !important;
    justify-content: center;
    min-height: 100vh;
    min-height: 100dvh;
  }

  .side-panel {
    flex-direction: row !important;
    width: 100% !important;
    justify-content: center;
    gap: 20px;
  }

  .side-panel.left {
    order: 1 !important;
  }

  .board-container {
    order: 2 !important;
  }

  .side-panel.right {
    order: 3 !important;
  }

  .chess-board {
    width: min(65vmin, 550px) !important;
    height: min(65vmin, 550px) !important;
  }

  .player-card {
    padding: 12px 16px !important;
    max-width: 220px !important;
    flex-direction: row !important;
  }

  .player-avatar {
    width: 44px !important;
    height: 44px !important;
  }

  .player-timer {
    font-size: 22px !important;
  }

  .game-actions {
    flex-direction: row !important;
    width: auto !important;
    padding: 12px !important;
    gap: 12px;
  }

  .game-actions-row {
    display: flex !important;
    gap: 12px;
  }

  .icon-btn {
    width: 48px !important;
    height: 48px !important;
    display: flex !important;
  }

  .move-history {
    display: none !important;
  }
}

/* ============================================
   SAFE AREA INSETS (notched phones)
   ============================================ */
@supports (padding: env(safe-area-inset-top)) {
  .app-container {
    padding-top: env(safe-area-inset-top);
    padding-bottom: env(safe-area-inset-bottom);
    padding-left: env(safe-area-inset-left);
    padding-right: env(safe-area-inset-right);
  }

  .toast-container {
    bottom: calc(10px + env(safe-area-inset-bottom)) !important;
    right: calc(10px + env(safe-area-inset-right)) !important;
    left: calc(10px + env(safe-area-inset-left)) !important;
  }

  .chat-overlay {
    bottom: calc(10px + env(safe-area-inset-bottom)) !important;
    right: calc(10px + env(safe-area-inset-right)) !important;
  }
}

/* ============================================
   HIGH DPI SCREENS
   ============================================ */
@media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
  .piece {
    image-rendering: -webkit-optimize-contrast;
    image-rendering: crisp-edges;
  }
}

/* ============================================
   TOUCH-FRIENDLY INTERACTIONS
   ============================================ */
@media (hover: none) and (pointer: coarse) {
  .square {
    -webkit-tap-highlight-color: transparent;
  }

  .piece {
    cursor: default;
  }

  .glass-button:active,
  .icon-btn:active {
    transform: scale(0.95);
  }

  .icon-btn {
    min-width: 44px;
    min-height: 44px;
  }
}

/* ============================================
   DARK MODE ADJUSTMENTS
   ============================================ */
@media (prefers-color-scheme: dark) {
  .chess-board {
    box-shadow: none;
  }
}

/* ============================================
   REDUCED MOTION
   ============================================ */
@media (prefers-reduced-motion: reduce) {
  .piece,
  .square,
  .glass-button,
  .icon-btn {
    transition: none !important;
    animation: none !important;
  }
}

/* ============================================
   PIECE DUPLICATION FIX
   ============================================ */
.square > .piece:not(:first-of-type),
.square > img.piece:nth-of-type(n+2),
.square .piece ~ .piece {
  display: none !important;
  visibility: hidden !important;
  opacity: 0 !important;
  width: 0 !important;
  height: 0 !important;
  position: absolute !important;
  pointer-events: none !important;
  z-index: -1 !important;
}

.square .piece {
  max-width: 100% !important;
  max-height: 100% !important;
  object-fit: contain !important;
}

/* ============================================
   MICROSOFT SURFACE DUO SUPPORT
   Surface Duo 1: 1350x1800 (2700x1800 spanned)
   Surface Duo 2: 1344x1892 (2688x1892 spanned)
   Each screen: ~540x720 usable
   ============================================ */

/* Surface Duo - Single screen mode (540x720 per screen) */
@media (min-width: 520px) and (max-width: 560px) and (min-height: 700px) and (max-height: 760px) {
  .app-container {
    padding: 4px !important;
    min-height: 100vh;
    min-height: 100dvh;
    overflow: hidden !important;
  }

  .game-container {
    display: flex !important;
    flex-direction: column !important;
    gap: 6px !important;
    padding: 4px !important;
    align-items: center;
    justify-content: flex-start !important;
    min-height: calc(100vh - 8px);
    min-height: calc(100dvh - 8px);
    max-height: 100vh;
    max-height: 100dvh;
    overflow: hidden !important;
  }

  .chess-board {
    width: min(95vw, calc(100vh - 200px), 480px) !important;
    height: min(95vw, calc(100vh - 200px), 480px) !important;
    max-width: 480px !important;
    max-height: 480px !important;
    flex-shrink: 0 !important;
  }

  .board-container {
    order: 2 !important;
    flex-shrink: 0 !important;
  }

  .side-panel {
    width: 100%;
    flex-direction: row !important;
    justify-content: center;
    gap: 8px;
    flex-shrink: 0 !important;
    padding: 4px 0 !important;
  }

  .side-panel.left {
    order: 1 !important;
  }

  .side-panel.right {
    order: 3 !important;
    flex-wrap: wrap !important;
  }

  .player-card {
    padding: 6px 10px !important;
    max-width: 180px;
    flex: 0 1 auto;
  }

  .player-avatar {
    width: 32px !important;
    height: 32px !important;
  }

  .player-name {
    font-size: 12px !important;
  }

  .player-timer {
    font-size: 16px !important;
  }

  .game-actions {
    order: 4 !important;
    width: 100% !important;
    flex-direction: row !important;
    justify-content: center !important;
    gap: 8px !important;
    padding: 6px !important;
    flex-shrink: 0 !important;
  }

  .game-actions-row {
    display: flex !important;
    gap: 8px !important;
  }

  .icon-btn {
    width: 40px !important;
    height: 40px !important;
    display: flex !important;
  }
  
  .board-coordinates {
    display: none !important;
  }
  
  .move-history {
    display: none !important;
  }
}

/* Surface Duo - Spanned mode using CSS Spanning API */
@media (horizontal-viewport-segments: 2) {
  :root {
    /* Dual screen environment variables */
    --fold-left: env(viewport-segment-right 0 0, 50%);
    --fold-right: env(viewport-segment-left 1 0, 50%);
    --fold-width: calc(var(--fold-right) - var(--fold-left));
  }

  .app-container {
    padding: 8px !important;
    min-height: 100vh;
    min-height: 100dvh;
    overflow: hidden !important;
  }

  .game-container {
    display: grid !important;
    grid-template-columns:
      env(viewport-segment-width 0 0, 50vw)
      env(viewport-segment-width 1 0, 50vw) !important;
    gap: 0 !important;
    padding: 8px !important;
    align-items: start !important;
    justify-content: stretch !important;
    min-height: calc(100vh - 16px);
    min-height: calc(100dvh - 16px);
    max-height: 100vh;
    max-height: 100dvh;
    overflow: hidden !important;
  }

  /* Left screen - Board */
  .board-container {
    grid-column: 1 !important;
    grid-row: 1 !important;
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
    justify-content: center !important;
    padding-right: calc(var(--fold-width) / 2 + 8px) !important;
    height: 100% !important;
  }

  .chess-board {
    width: min(calc(env(viewport-segment-width 0 0, 50vw) - 40px), calc(100vh - 100px), 600px) !important;
    height: min(calc(env(viewport-segment-width 0 0, 50vw) - 40px), calc(100vh - 100px), 600px) !important;
    max-width: 600px !important;
    max-height: 600px !important;
    flex-shrink: 0 !important;
  }

  /* Right screen - Players and controls */
  .side-panel {
    grid-column: 2 !important;
    flex-direction: column !important;
    justify-content: flex-start !important;
    align-items: center !important;
    width: 100% !important;
    padding-left: calc(var(--fold-width) / 2 + 8px) !important;
    gap: 12px !important;
  }

  .side-panel.left {
    grid-row: 1 !important;
    order: unset !important;
  }

  .side-panel.right {
    display: none !important;
  }

  .player-card {
    width: 100% !important;
    max-width: 280px !important;
    padding: 12px 16px !important;
  }

  .player-avatar {
    width: 44px !important;
    height: 44px !important;
  }

  .player-name {
    font-size: 14px !important;
  }

  .player-timer {
    font-size: 22px !important;
  }

  .game-actions {
    grid-column: 2 !important;
    width: 100% !important;
    max-width: 280px !important;
    flex-direction: column !important;
    justify-content: flex-start !important;
    gap: 10px !important;
    padding: 12px !important;
    padding-left: calc(var(--fold-width) / 2 + 20px) !important;
  }

  .game-actions-row {
    display: flex !important;
    gap: 10px !important;
    justify-content: center !important;
  }

  .icon-btn {
    width: 48px !important;
    height: 48px !important;
    display: flex !important;
  }

  .move-history {
    display: block !important;
    grid-column: 2 !important;
    max-height: 200px !important;
    width: 100% !important;
    max-width: 280px !important;
    padding-left: calc(var(--fold-width) / 2 + 8px) !important;
  }
  
  .board-coordinates {
    display: none !important;
  }
}

/* Surface Duo - Fallback using screen dimensions */
@media (min-width: 2600px) and (max-width: 2800px) and (min-height: 1700px) and (max-height: 2000px) {
  .app-container {
    padding: 12px !important;
  }

  .game-container {
    display: grid !important;
    grid-template-columns: 1fr 1fr !important;
    gap: 80px !important;
    padding: 12px !important;
    max-width: 100% !important;
    align-items: start !important;
  }

  /* Left half - Board */
  .board-container {
    grid-column: 1 !important;
    display: flex !important;
    justify-content: center !important;
    align-items: center !important;
    padding-right: 40px !important;
  }

  .chess-board {
    width: min(calc(50vw - 100px), calc(100vh - 100px), 700px) !important;
    height: min(calc(50vw - 100px), calc(100vh - 100px), 700px) !important;
    max-width: 700px !important;
    max-height: 700px !important;
  }

  /* Right half - Players and controls */
  .side-panel {
    grid-column: 2 !important;
    flex-direction: column !important;
    width: 100% !important;
    padding-left: 40px !important;
    gap: 16px !important;
  }

  .side-panel.left {
    order: unset !important;
  }

  .side-panel.right {
    display: none !important;
  }

  .player-card {
    width: 100% !important;
    max-width: 320px !important;
    padding: 14px 20px !important;
  }

  .player-avatar {
    width: 48px !important;
    height: 48px !important;
  }

  .player-name {
    font-size: 16px !important;
  }

  .player-timer {
    font-size: 24px !important;
  }

  .game-actions {
    grid-column: 2 !important;
    width: 100% !important;
    max-width: 320px !important;
    flex-direction: column !important;
    gap: 12px !important;
    padding: 16px !important;
    padding-left: 56px !important;
  }

  .game-actions-row {
    display: flex !important;
    gap: 12px !important;
    justify-content: center !important;
  }

  .icon-btn {
    width: 52px !important;
    height: 52px !important;
  }

  .move-history {
    display: block !important;
    grid-column: 2 !important;
    max-height: 300px !important;
    width: 100% !important;
    max-width: 320px !important;
    padding-left: 40px !important;
  }
  
  .board-coordinates {
    display: none !important;
  }
}

/* ============================================
   PRINT STYLES
   ============================================ */
@media print {
  .game-actions,
  .chat-overlay,
  .toast-container {
    display: none !important;
  }
  
  .chess-board {
    width: 400px !important;
    height: 400px !important;
    box-shadow: none !important;
  }
}